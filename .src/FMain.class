' Gambas class file

Public Sub ButtonConversion_Click()

    'ok empezar a convertir
    convertir()

End

Public Sub ButtonDefinirRutaYFichero_Click()

    Dialog.Title = "Elege la ruta y el nombre que se guardará el fichero .bc3"

    If Dialog.SaveFile() Then
    Else
        If File.Ext(Dialog.Path) = "" Then
            Dialog.Path &= ".bc3"
        Endif
        TextBoxRuta.text = Dialog.Path
    Endif

End

Public Sub convertir()

    Dim codigo As String
    Dim ltmp As String
    Dim lineas As String[]
    Dim tokes As String[]
    Dim id, unidad, textocorto, precio, textolargo As String
    Dim salida As String

    codigo = SimpleBC3.BC3version()

    codigo &= SimpleBC3.BC3NombrePresupuesto(File.BaseName(TextBoxRuta.text), "0")

    lineas = Split(TextAreaContenido.text, "\n")

    lineas.Delete(0) 'la primera linea continene la cabecera del nombre de las columnas

    For Each ltmp In lineas
        tokes = Split(ltmp, gb.tab)
        If Len(tokes.Join("")) < 1 Then
            Continue
            'LINEA VACIA

        Endif
        id = tokes[0]
        unidad = tokes[1]
        textocorto = tokes[2]

        precio = Replace(tokes[3], ".", ",") 'eemplazado de punto decimal a coma decimal
        textolargo = tokes[4]

        codigo &= SimpleBC3.BC3Conceptos(id, unidad, textocorto, precio)
        If Len(textolargo) <> 0 Then
            'si no hay texto, no lo escribe
            codigo &= SimpleBC3.BC3Texto(id, textolargo)
        Endif

    Next

    salida = SimpleBC3.ConversionCaracteres(codigo)
    If salida <> "" Then
        TextAreaSalida.text = codigo

    Endif

End

Public Sub ButtonGuardar_Click()

    If TextBoxRuta.text = "" Then
        Message.error("Elige la ruta y el nombre del fichero .bc3 para guardar los datos...")
    Else
        file.Save(TextBoxRuta.text, TextAreaSalida.text)
        Message.Info("Información Guardada...")
    Endif

End
